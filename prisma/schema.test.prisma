generator client {
  provider = "prisma-client-js"
  output   = "../tests/prisma-client"
}

datasource db {
  provider = "sqlite"
  url      = env("TEST_DATABASE_URL")
}

model Specialty {
  id                         String                @id @default(uuid())
  name                       String                @unique
  defaultSlotDurationMinutes Int
  active                     Boolean               @default(true)
  professionals              ProfessionalProfile[]
}

model User {
  id           String               @id @default(uuid())
  email        String               @unique
  passwordHash String
  role         String
  name         String
  lastName     String
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  professional ProfessionalProfile?
  patient      PatientProfile?
  resetTokens  PasswordResetToken[]
}

model ProfessionalProfile {
  id                  String        @id @default(uuid())
  userId              String        @unique
  specialtyId         String
  slotDurationMinutes Int?
  active              Boolean       @default(true)
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialty           Specialty     @relation(fields: [specialtyId], references: [id], onDelete: Restrict)
  timeSlots           TimeSlot[]
  appointments        Appointment[]
}

model PatientProfile {
  id           String        @id @default(uuid())
  userId       String        @unique
  phone        String?
  documentId   String?
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments Appointment[]
}

model TimeSlot {
  id             String              @id @default(uuid())
  professionalId String
  startAt        DateTime
  endAt          DateTime
  status         String              @default("AVAILABLE")
  professional   ProfessionalProfile @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  appointment    Appointment?

  @@index([professionalId])
  @@index([startAt])
}

model Appointment {
  id             String              @id @default(uuid())
  patientId      String
  professionalId String
  timeSlotId     String              @unique
  reason         String
  notes          String?
  status         String              @default("PENDING")
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  patient        PatientProfile      @relation(fields: [patientId], references: [id], onDelete: Restrict)
  professional   ProfessionalProfile @relation(fields: [professionalId], references: [id], onDelete: Restrict)
  timeSlot       TimeSlot            @relation(fields: [timeSlotId], references: [id], onDelete: Restrict)

  @@index([patientId])
  @@index([professionalId])
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}
